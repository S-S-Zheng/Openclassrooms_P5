# CI vérif auto code est propre, passe les tests et est maintenable avant CD
# S'éxé à chaque push/PR sans déploy, secrets et modif d'env externes
---
name: CI Pipeline

# Déclencheurs
# Lance le workflow à chaque push sur main, develop et à chaque pull request
# vers main si PR change. 
on:
  push:
    branches:
      - main
      - develop
# pull_request:
#   branches:
#     - main
#   types: [synchronize, opened]

# Variables d'environnement globales
env:
  PYTHON_VERSION: '3.11'

# Jobs
jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    # étapes du lint
    steps:
      # Clone le dépôt dans le runner
      - name: Checkout code
        uses: actions/checkout@v4
      # Configure python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      # Installe les outils de lint
      - name: Install lint tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
      # Exécute les outils de lint
      - name: Run isort
        run: isort --profile black --check-only app/ tests/
      - name: Run Black
        run: black --check app/ tests/
      # E203 (conflits avec les slices formatés par black)
      # W503 (black pref les operateurs en début de ligne)
      # sont ignorés pour compatibilité avec Black
      - name: Run Flake8
        run: flake8 app/ tests/ --max-line-length=100 --extend-ignore=E203,W503

  test:
    name: test
    runs-on: ubuntu-latest
    # Oblige la validation de lint avant
    needs: lint
    env:
      # on déf les variables pour les utiliser dans le test
      POSTGRES_USER_TEST: ${{ secrets.POSTGRES_USER_TEST }}
      POSTGRES_PASSWORD_TEST: ${{ secrets.POSTGRES_PASSWORD_TEST }}
      POSTGRES_DB_TEST: ${{ secrets.POSTGRES_DB_TEST }}
      POSTGRES_HOST_TEST: ${{ secrets.POSTGRES_HOST_TEST }}
      POSTGRES_PORT_TEST: ${{ secrets.POSTGRES_PORT_TEST }}
      # du a database.py
      POSTGRES_USER: ${{ secrets.POSTGRES_USER_TEST }}
      POSTGRES_PORT: ${{ secrets.POSTGRES_PORT_TEST }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD_TEST }}
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST_TEST }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB_TEST }}
    services:
      # service lance un conteneur docker séparé d'où l'env a réiterer
      # postgre attend nécéssairement les variables nommés ci-dessous (d'ou pas de _TEST)
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER_TEST }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD_TEST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB_TEST }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # Active cache pip pour accelerer installation
          cache: 'pip'
      # Installe les dépendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      # Lance les tests avec coverage
      - name: Run tests with coverage
        run: |
          pytest
      # Créer un rapport de couverture HTML
      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
